@model StockTakingIndexViewModel
@using StockTakingApp.Models.Enums
@{
    var isAdmin = User.IsInRole("Admin");
    
    string SortUrl(string column)
    {
        var isCurrentSort = Model.StockTakings.SortBy?.Equals(column, StringComparison.OrdinalIgnoreCase) == true;
        var newDesc = isCurrentSort && !Model.StockTakings.SortDesc;
        var search = Model.StockTakings.Search;
        var status = Model.StatusFilter;
        
        var url = $"/stocktaking?sortBy={column}&sortDesc={newDesc}";
        if (!string.IsNullOrEmpty(search)) url += $"&search={Uri.EscapeDataString(search)}";
        if (status.HasValue) url += $"&status={status}";
        return url;
    }
    
    string SortClass(string column)
    {
        var isCurrentSort = Model.StockTakings.SortBy?.Equals(column, StringComparison.OrdinalIgnoreCase) == true;
        if (!isCurrentSort) return "sortable";
        return Model.StockTakings.SortDesc ? "sortable sorted desc" : "sortable sorted";
    }
}

@if (Model.StockTakings.Items.Any())
{
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th class="@SortClass("location")"
                        hx-get="@SortUrl("location")"
                        hx-target="#list-container"
                        hx-swap="innerHTML"
                        hx-push-url="true">
                        Location
                        <svg class="sort-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 4L8 12M8 4L5 7M8 4L11 7"/>
                        </svg>
                    </th>
                    <th class="@SortClass("status")"
                        hx-get="@SortUrl("status")"
                        hx-target="#list-container"
                        hx-swap="innerHTML"
                        hx-push-url="true">
                        Status
                        <svg class="sort-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 4L8 12M8 4L5 7M8 4L11 7"/>
                        </svg>
                    </th>
                    <th class="@SortClass("progress")"
                        hx-get="@SortUrl("progress")"
                        hx-target="#list-container"
                        hx-swap="innerHTML"
                        hx-push-url="true">
                        Progress
                        <svg class="sort-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 4L8 12M8 4L5 7M8 4L11 7"/>
                        </svg>
                    </th>
                    <th>Assigned To</th>
                    <th class="@SortClass("created")"
                        hx-get="@SortUrl("created")"
                        hx-target="#list-container"
                        hx-swap="innerHTML"
                        hx-push-url="true">
                        Created
                        <svg class="sort-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 4L8 12M8 4L5 7M8 4L11 7"/>
                        </svg>
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var st in Model.StockTakings.Items)
                {
                    var statusClass = st.Status switch
                    {
                        StockTakingStatus.Requested => "status-requested",
                        StockTakingStatus.InProgress => "status-in-progress",
                        StockTakingStatus.Completed => "status-completed",
                        _ => ""
                    };
                    <tr>
                        <td>
                            <div class="font-medium">@st.LocationName</div>
                            <div class="text-xs text-muted">@st.LocationCode</div>
                        </td>
                        <td><span class="badge @statusClass">@st.StatusDisplay</span></td>
                        <td>
                            <div class="flex items-center gap-sm">
                                <div class="progress" style="width: 80px;">
                                    <div class="progress-bar @(st.ProgressPercent == 100 ? "success" : "")" style="width: @st.ProgressPercent%"></div>
                                </div>
                                <span class="text-sm text-muted">@st.CountedItems/@st.TotalItems</span>
                            </div>
                        </td>
                        <td class="text-sm">@string.Join(", ", st.AssignedWorkers)</td>
                        <td class="text-sm text-muted">@st.CreatedAt.ToString("MMM dd, HH:mm")</td>
                        <td class="table-actions">
                            <a asp-action="Details" asp-route-id="@st.Id" class="btn btn-sm btn-secondary">View</a>
                            @if (st.Status == StockTakingStatus.Requested || st.Status == StockTakingStatus.InProgress)
                            {
                                <a asp-action="Perform" asp-route-id="@st.Id" class="btn btn-sm btn-primary">Count</a>
                            }
                            @if (isAdmin && st.Status == StockTakingStatus.Completed)
                            {
                                <a asp-action="Review" asp-route-id="@st.Id" class="btn btn-sm btn-success">Review</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <div class="card-footer">
        @await Html.PartialAsync("~/Views/Shared/_Pagination.cshtml", Model.Pagination)
    </div>
}
else
{
    <div class="card-body">
        <div class="empty-state">
            <p>No stock taking sessions found</p>
            @if (!string.IsNullOrEmpty(Model.StockTakings.Search) || Model.StatusFilter.HasValue)
            {
                <a href="/stocktaking" class="btn btn-secondary mt-md">Clear Filters</a>
            }
            else if (isAdmin)
            {
                <a asp-action="Create" class="btn btn-primary mt-md">Create First Stock Taking</a>
            }
            else
            {
                <p class="text-sm text-muted mt-sm">You will be notified when assigned to a stock taking session.</p>
            }
        </div>
    </div>
}
