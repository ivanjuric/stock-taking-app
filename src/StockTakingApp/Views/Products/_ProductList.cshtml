@model ProductListViewModel
@{
    string SortUrl(string column)
    {
        var isCurrentSort = Model.Products.SortBy?.Equals(column, StringComparison.OrdinalIgnoreCase) == true;
        var newDesc = isCurrentSort && !Model.Products.SortDesc;
        var search = Model.Products.Search;
        var category = Model.CategoryFilter;
        
        var url = $"/products?sortBy={column}&sortDesc={newDesc}";
        if (!string.IsNullOrEmpty(search)) url += $"&search={Uri.EscapeDataString(search)}";
        if (!string.IsNullOrEmpty(category)) url += $"&category={Uri.EscapeDataString(category)}";
        return url;
    }
    
    string SortClass(string column)
    {
        var isCurrentSort = Model.Products.SortBy?.Equals(column, StringComparison.OrdinalIgnoreCase) == true;
        if (!isCurrentSort) return "sortable";
        return Model.Products.SortDesc ? "sortable sorted desc" : "sortable sorted";
    }
}

<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Photos</th>
                <th class="@SortClass("sku")"
                    hx-get="@SortUrl("sku")"
                    hx-target="#list-container"
                    hx-swap="innerHTML"
                    hx-push-url="true">
                    SKU
                    <svg class="sort-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 4L8 12M8 4L5 7M8 4L11 7"/>
                    </svg>
                </th>
                <th class="@SortClass("name")"
                    hx-get="@SortUrl("name")"
                    hx-target="#list-container"
                    hx-swap="innerHTML"
                    hx-push-url="true">
                    Name
                    <svg class="sort-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 4L8 12M8 4L5 7M8 4L11 7"/>
                    </svg>
                </th>
                <th class="@SortClass("category")"
                    hx-get="@SortUrl("category")"
                    hx-target="#list-container"
                    hx-swap="innerHTML"
                    hx-push-url="true">
                    Category
                    <svg class="sort-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 4L8 12M8 4L5 7M8 4L11 7"/>
                    </svg>
                </th>
                <th>Description</th>
                <th class="table-actions-header"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in Model.Products.Items)
            {
                <tr id="product-@product.Id">
                    <td>
                        @await Html.PartialAsync("~/Views/Shared/_PhotoGallery.cshtml", (product.Photos, $"product-{product.Id}"))
                    </td>
                    <td><code>@product.Sku</code></td>
                    <td class="font-medium">@product.Name</td>
                    <td><span class="badge badge-primary">@product.Category</span></td>
                    <td class="text-muted text-sm">@(product.Description ?? "-")</td>
                    <td class="table-actions-cell">
                        <div class="table-actions">
                            <a href="#qr-@product.Id" class="btn btn-sm btn-secondary btn-icon" title="Show QR Code">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                    <rect x="14" y="14" width="3" height="3"/>
                                    <rect x="18" y="14" width="3" height="3"/>
                                    <rect x="14" y="18" width="3" height="3"/>
                                    <rect x="18" y="18" width="3" height="3"/>
                                </svg>
                            </a>
                            <a asp-action="Edit" asp-route-id="@product.Id" class="btn btn-sm btn-secondary">Edit</a>
                            <button type="button" class="btn btn-sm btn-danger"
                                    hx-delete="/products/delete/@product.Id"
                                    hx-target="#product-@product.Id"
                                    hx-swap="outerHTML"
                                    hx-confirm="Are you sure you want to delete this product?">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (Model.Products.TotalItems == 0)
{
    <div class="card-body">
        <div class="empty-state">
            <p>No products found</p>
            @if (!string.IsNullOrEmpty(Model.Products.Search) || !string.IsNullOrEmpty(Model.CategoryFilter))
            {
                <a href="/products" class="btn btn-secondary mt-md">Clear Filters</a>
            }
            else
            {
                <a asp-action="Create" class="btn btn-primary mt-md">Add First Product</a>
            }
        </div>
    </div>
}
else
{
    <div class="card-footer">
        @await Html.PartialAsync("~/Views/Shared/_Pagination.cshtml", Model.Pagination)
    </div>
}

@* QR Code Modals - CSS-only using :target *@
@foreach (var product in Model.Products.Items)
{
    <div id="qr-@product.Id" class="modal">
        <a href="#!" class="modal-backdrop"></a>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">QR Code - @product.Sku</h3>
                <a href="#!" class="modal-close" title="Close">&times;</a>
            </div>
            <div class="modal-body">
                <div class="qr-code-container">
                    <div class="qr-code">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=@Uri.EscapeDataString(product.Sku)" 
                             alt="QR Code for @product.Sku" 
                             width="200" 
                             height="200" />
                    </div>
                    <span class="qr-code-label">@product.Sku</span>
                    <span class="text-muted text-sm">@product.Name</span>
                </div>
            </div>
        </div>
    </div>
}

@* Photo Lightbox Modals - CSS-only using :target *@
@foreach (var product in Model.Products.Items)
{
    @await Html.PartialAsync("~/Views/Shared/_PhotoLightbox.cshtml", (product.Photos, $"product-{product.Id}"))
}
