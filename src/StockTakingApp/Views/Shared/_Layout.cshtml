<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="htmx-config" content='{"includeIndicatorStyles": false}' />
    <title>@ViewData["Title"] - Stock Taking App</title>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    @Html.AntiForgeryToken()
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme && savedTheme !== 'system') {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        })();
    </script>
</head>
<body>
    <script>
        document.body.addEventListener('htmx:configRequest', function(evt) {
            var token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                evt.detail.headers['RequestVerificationToken'] = token.value;
            }
        });
        
        // Theme management
        const ThemeManager = {
            init() {
                this.updateActiveButton();
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (this.getTheme() === 'system') {
                        // Re-apply to trigger any needed updates
                        this.setTheme('system');
                    }
                });
            },
            
            getTheme() {
                return localStorage.getItem('theme') || 'system';
            },
            
            setTheme(theme) {
                localStorage.setItem('theme', theme);
                
                if (theme === 'system') {
                    document.documentElement.removeAttribute('data-theme');
                } else {
                    document.documentElement.setAttribute('data-theme', theme);
                }
                
                this.updateActiveButton();
            },
            
            updateActiveButton() {
                const currentTheme = this.getTheme();
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === currentTheme);
                });
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => ThemeManager.init());
    </script>
    @if (User.Identity?.IsAuthenticated == true)
    {
        <div class="app-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                        </svg>
                        Stock Taking
                    </div>
                </div>
                
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Main</div>
                        <a asp-controller="Home" asp-action="Index" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Home" ? "active" : "")">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                            Dashboard
                        </a>
                        <a asp-controller="StockTaking" asp-action="Index" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "StockTaking" ? "active" : "")">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                                <rect x="9" y="3" width="6" height="4" rx="1"/>
                                <path d="M9 14l2 2 4-4"/>
                            </svg>
                            Stock Taking
                        </a>
                    </div>
                    
                    @if (User.IsInRole("Admin"))
                    {
                        <div class="nav-section">
                            <div class="nav-section-title">Inventory</div>
                            <a asp-controller="Products" asp-action="Index" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Products" ? "active" : "")">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                                    <line x1="7" y1="7" x2="7.01" y2="7"/>
                                </svg>
                                Products
                            </a>
                            <a asp-controller="Locations" asp-action="Index" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Locations" ? "active" : "")">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                Locations
                            </a>
                            <a asp-controller="Stock" asp-action="Index" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Stock" ? "active" : "")">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                Stock Levels
                            </a>
                        </div>
                    }
                </nav>
                
                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">
                            @User.Identity?.Name?.Substring(0, 1).ToUpper()
                        </div>
                        <div class="user-details">
                            <div class="user-name">@User.FindFirst("FullName")?.Value</div>
                            <div class="user-role">@User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value</div>
                        </div>
                    </div>
                    
                    <div class="theme-switcher" role="group" aria-label="Theme switcher">
                        <button type="button" class="theme-btn" data-theme="light" onclick="ThemeManager.setTheme('light')" title="Light mode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        </button>
                        <button type="button" class="theme-btn" data-theme="system" onclick="ThemeManager.setTheme('system')" title="System preference">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                <line x1="8" y1="21" x2="16" y2="21"/>
                                <line x1="12" y1="17" x2="12" y2="21"/>
                            </svg>
                        </button>
                        <button type="button" class="theme-btn" data-theme="dark" onclick="ThemeManager.setTheme('dark')" title="Dark mode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <form asp-controller="Account" asp-action="Logout" method="post" style="margin-top: 0.5rem;">
                        <button type="submit" class="btn btn-secondary" style="width: 100%;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            Logout
                        </button>
                    </form>
                </div>
            </aside>
            
            <div class="main-content">
                <header class="main-header">
                    <h1 class="page-title">@ViewData["Title"]</h1>
                    <div class="header-actions">
                        <div class="notification-btn" 
                             hx-ext="sse" 
                             sse-connect="/notifications/stream"
                             sse-swap="message"
                             hx-swap="beforeend:#toast-container">
                            <a asp-controller="Notifications" asp-action="Index" class="btn btn-icon btn-secondary">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                </svg>
                                <span id="notification-count" class="notification-badge" 
                                      hx-get="/notifications/unreadcount" 
                                      hx-trigger="load, sse:notification-update"
                                      hx-swap="innerHTML"></span>
                            </a>
                        </div>
                    </div>
                </header>
                
                <main class="main-body">
                    @RenderBody()
                </main>
            </div>
        </div>
        
        <div id="toast-container" class="toast-container"></div>
    }
    else
    {
        @RenderBody()
    }

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
